### 什么是挂载和更新？

挂载（Mount）就是把虚拟 DOM（也就是我们常说的 vnode）变成真实的 DOM 元素，然后塞到页面里去。更新（Update）呢，就是当数据变了，页面得跟着变，我们需要对比新旧虚拟 DOM，找出变化的地方，然后高效地调整真实 DOM。这两个过程是前端框架（如 Vue.js）能动态渲染页面的核心。



### 挂载的秘密：子节点和属性

#### 子节点的渲染

咱们先从挂载子节点开始。假设你有一个虚拟 DOM 长这样：

```js
const vnode = {
  type: 'div',
  children: [
    {
      type: 'p',
      children: 'hello'
    }
  ]
}
```

这就像在说：“给我搭一个 div，里面放一个 p 标签，p 标签里写上‘hello’。”这里 children 是个数组，里面装着子节点的虚拟 DOM 对象。这就形成了一个树形结构，也就是我们常说的虚拟 DOM 树。

怎么把它挂载到页面上呢？我们得有个 mountElement 函数：

```js
function mountElement(vnode, container) {
  const el = document.createElement(vnode.type)  // 创建 div 元素
  if (typeof vnode.children === 'string') {
    el.textContent = vnode.children  // 如果子节点是字符串，直接设为文本
  } else if (Array.isArray(vnode.children)) {
    // 如果是数组，遍历每个子节点，递归挂载
    vnode.children.forEach(child => {
      patch(null, child, el)
    })
  }
  container.appendChild(el)  // 把搭好的元素塞进容器
}
```

这里的关键是 patch 函数。它负责把虚拟 DOM 变成真实 DOM。第一次挂载时，旧节点（第一个参数）是 null，所以它会直接调用 mountElement 继续搭积木。注意，子节点挂载时，容器得传 el，因为这些子节点是要塞进刚刚创建的 div 里的。

#### 属性的渲染

除了子节点，一个元素还有属性，比如 id、class 啥的。怎么描述这些属性呢？我们给虚拟 DOM 加个 props 字段：

```js
const vnode = {
  type: 'div',
  props: {
    id: 'foo'
  },
  children: [
    {
      type: 'p',
      children: 'hello'
    }
  ]
}
```

然后在 mountElement 里处理它：

```js
function mountElement(vnode, container) {
  const el = document.createElement(vnode.type)
  // 处理子节点（略）
  if (vnode.props) {
    for (const key in vnode.props) {
      el.setAttribute(key, vnode.props[key])  // 设置属性
    }
  }
  container.appendChild(el)
}
```

简单吧？遍历 props 对象，用 setAttribute 把每个属性设置到元素上。但这只是最基础的做法，后面我们会发现，属性处理没这么简单。



### HTML Attributes 和 DOM Properties 的纠结

#### 啥是 Attributes 和 Properties？

假设有这么个 HTML：

```html
<input id="my-input" type="text" value="foo" />
```

- **HTML Attributes**：就是写在标签上的东西，像 id="my-input"、value="foo"。

- **DOM Properties**：浏览器解析完 HTML 后，生成 DOM 对象（比如 input 元素），上面有一堆属性，比如 el.id、el.value。

很多时候，Attributes 和 Properties 是对应的，比如 id="my-input" 对应 el.id。但也有例外：

- `<div class="foo"> `的 class 属性，对应的 DOM Properties 是 el.className。
- 有些 Attributes 没对应的 Properties，比如 aria-valuenow="75"。
- 反过来，有些 Properties 没对应的 Attributes，比如 el.textContent。

#### 初始值和动态值的区别

Attributes 和 Properties 的关系还有个关键点：**Attributes 是用来设置 Properties 的初始值**。举个例子：

```html
<input value="foo" />
```

初始时，el.value 是 "foo"。但如果用户在输入框里改成了 "bar"：

- el.value 变成 "bar"（当前值）。
- el.getAttribute('value') 还是 "foo"（初始值）。
- 想拿初始值还能用 el.defaultValue，也是 "foo"。

再比如：

```html
<input type="foo" />
```

type="foo" 是不合法的，浏览器会自动矫正成 "text"，所以 el.type 是 "text"，而不是 "foo"。

总结一下：Attributes 定初始值，Properties 管当前值。明白了这个，后面处理属性时就不会晕了。



### 正确设置属性的姿势

