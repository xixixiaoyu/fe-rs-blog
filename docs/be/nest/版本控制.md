### 什么是版本控制？

想象一下，你开了一家餐馆，菜单更新了，新菜品很受欢迎，但有些老顾客就是喜欢以前的经典口味。你总不能直接把老菜撤了吧？版本控制就像是给你的应用开了个“分身术”，让新老版本和平共存。它允许你在同一个程序里跑不同的控制器或路由，满足不同用户的需求。

在 HTTP 应用中，版本控制有 4 种常见方式：

1. **URI 版本控制**：通过 URL 里的版本号区分，比如 https://example.com/v1/route。
2. **请求头版本控制**：用请求头告诉服务器我要哪个版本。
3. **媒体类型版本控制**：通过 Accept 请求头指定版本。
4. **自定义版本控制**：你自己定义怎么提取版本，灵活度拉满。

下面，咱们就挨个聊聊这几种方式，顺便看看怎么用代码实现。



### 一、URI 版本控制：简单直接

这是最常见的一种方式，直接在 URL 里写上版本号，比如 v1、v2，一目了然。就像餐馆里菜单上标着“经典版”和“升级版”，顾客一看就知道要点啥。

在 NestJS 里（一个流行的 Node.js 框架），你只需要在 main.ts 里加几行代码：

```ts
const app = await NestFactory.create(AppModule)
app.enableVersioning({
  type: VersioningType.URI
})
await app.listen(process.env.PORT ?? 3000)
```

这样，应用就开启了 URI 版本控制。默认情况下，版本号会带个 v 前缀，比如 /v1/cats。如果你不喜欢这个 v，可以改掉：

```js
app.enableVersioning({
  type: VersioningType.URI,
  prefix: 'version'  // 变成 /version1/cats
  // 或者 prefix: false  // 直接 /1/cats
})
```

**小贴士**：这里的 VersioningType 是从 @nestjs/common 里导入的。



### 二、请求头版本控制：低调高级

如果觉得 URL 里加版本号太显眼，可以试试请求头版本控制。它通过自定义请求头悄悄告诉你用哪个版本。比如，发送请求时加个头：Custom-Header: 2，服务器就知道你要版本 2。

代码也很简单：

```js
const app = await NestFactory.create(AppModule)
app.enableVersioning({
  type: VersioningType.HEADER,
  header: 'Custom-Header'
})
await app.listen(process.env.PORT ?? 3000)
```

客户端发请求时，只要带上这个头就行。比如用 curl：

```text
curl -H "Custom-Header: 1" https://example.com/cats
```

这种方式的好处是 URL 不变，看起来干净，但需要客户端配合加头，稍微麻烦点。



### 三、媒体类型版本控制：优雅专业

这是通过 Accept 请求头来指定版本的方式，常用于 API 设计。比如，请求头可能是：

```text
Accept: application/json;v=2
```

服务器看到 v=2，就知道你要版本 2 的数据。这种方式很“RESTful”，适合追求规范的场景。

配置方法：

```
const app = await NestFactory.create(AppModule)
app.enableVersioning({
  type: VersioningType.MEDIA_TYPE,
  key: 'v='
})
await app.listen(process.env.PORT ?? 3000)
```

这里的 key 是用来识别版本的标志，v= 意味着版本号跟在 v= 后面。你也可以改成别的，比如 version=。



### 四、自定义版本控制：随心所欲

如果上面三种都不够灵活，那就用自定义版本控制。你可以写个函数，从请求的任何部分（头、参数、甚至 body）里提取版本，想怎么玩就怎么玩。

假设你想从请求头 custom-versioning-field 里拿版本，还支持多个版本：

```js
const extractor = (request) => {
  const versions = (request.headers['custom-versioning-field'] || '')
    .split(',')
    .filter(v => v)
    .sort()
    .reverse()  // 高版本优先
  return versions  // 比如 ['3', '2', '1']
}

const app = await NestFactory.create(AppModule)
app.enableVersioning({
  type: VersioningType.CUSTOM,
  extractor
})
await app.listen(process.env.PORT ?? 3000)
```

